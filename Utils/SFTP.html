<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<link rel="stylesheet" type="text/css" href="file:///${exe}/scripts/highlight.styles/${SyntaxHighlightStyleName}.css" />
		<style>
			table{border-collapse: collapse; border: 1px solid gray; border-width: 2px 1px 2px 1px;}
			th{border: 1px solid gray; padding: 4px; background-color: #ddd;}
			td{border: 1px solid gray; padding: 4px;}
			tr:nth-child(2n){background-color: #f8f8f8;}
			pre{border: 2px solid #d6d6d6; padding: 0px; border-radius: 3px;}
		</style>
	</head>
	<body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">
		<div>1.接口：IfClient
		</div>
		<div>
			<pre>
<code id="ID_1634DECB121" class="lang-java hljs"><ol><li><span class="hljs-keyword">package</span> com.cmcc.omc.ftp;</li><li></li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.SftpException;</li><li></li><li></li><li><span class="hljs-comment">/**</span></li><li> * FTP/SFTP客户端接口类&lt;br&gt;</li><li> */</li><li><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IfClient</span></span></li><li>{</li><li>    <span class="hljs-comment">/**</span></li><li>     * 与远端FTP/SFTP服务器建立连接</li><li>     * <span class="hljs-doctag">@throws</span> InvokeException 异常</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span></span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 断开与远端FTP/SFTP服务器的连接&lt;br&gt;</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span></span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 上载文件&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcPath 文件所在的本地目录路径</li><li>     * <span class="hljs-doctag">@param</span> destPath 存放文件的服务器目录路径</li><li>     * <span class="hljs-doctag">@throws</span> SftpException  SFTP异常</li><li>     * <span class="hljs-doctag">@throws</span> InvokeException 异常</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">upload</span><span class="hljs-params">(String srcPath, String destPath)</span> <span class="hljs-keyword">throws</span> SftpException</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 下载文件&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcPath 文件所在的服务器目录路径</li><li>     * <span class="hljs-doctag">@param</span> destPath 用于存放文件的本地目录路径</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">download</span><span class="hljs-params">(String srcPath, String destPath)</span></span>;</li><li>    </li><li>    <span class="hljs-comment">/**</span></li><li>     * FTP/SFTP远程对现有的文件重命名</li><li>     * </li><li>     * <span class="hljs-doctag">@param</span> oldname 原名称</li><li>     * <span class="hljs-doctag">@param</span> newname 新名称</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeName</span><span class="hljs-params">(String oldname, String newname)</span></span>;</li><li>    </li><li>    <span class="hljs-comment">/**</span></li><li>     * 设置密钥路径</li><li>     * <span class="hljs-doctag">@param</span> path 密钥路径</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setKeyPath</span><span class="hljs-params">(String path)</span></span>;</li><li></li><li>}</li><li></li></ol></code></pre>
			<div><br />
			</div>
		</div>
		<div>2.实现：SftpClientImpl
		</div>
		<div>
			<pre>
<code id="ID_1634DED98BE" class="lang-java hljs"><ol><li><span class="hljs-keyword">package</span> com.cmcc.omc.ftp;</li><li></li><li><span class="hljs-keyword">import</span> java.io.File;</li><li><span class="hljs-keyword">import</span> java.io.FileInputStream;</li><li><span class="hljs-keyword">import</span> java.io.FileNotFoundException;</li><li><span class="hljs-keyword">import</span> java.io.IOException;</li><li><span class="hljs-keyword">import</span> java.io.OutputStream;</li><li><span class="hljs-keyword">import</span> java.util.List;</li><li><span class="hljs-keyword">import</span> java.util.Vector;</li><li></li><li><span class="hljs-keyword">import</span> com.cmcc.omc.common.FileUtil;</li><li><span class="hljs-keyword">import</span> com.huawei.ibridge.framework.base.log.LogFactory;</li><li><span class="hljs-keyword">import</span> com.huawei.ibridge.framework.base.log.Logger;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.Channel;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.ChannelSftp;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.JSch;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.Session;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.SftpATTRS;</li><li><span class="hljs-keyword">import</span> com.jcraft.jsch.SftpException;</li><li></li><li><span class="hljs-comment">/**</span></li><li> * SFTP客户端实现类，实现IfClient接口&lt;br&gt;</li><li> */</li><li><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SftpClientImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IfClient</span></span></li><li>{</li><li>    <span class="hljs-comment">/**</span></li><li>     * The Constant log</li><li>     */</li><li>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LogFactory.getLogger(SftpClientImpl.class);</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 目录不存在异常ID常量</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ID_EX_DIRNOTEXIST = <span class="hljs-number">2</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 创建目录失败异常ID常量</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ID_EX_MKDIRFAILD = <span class="hljs-number">5</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 创建目录位置异常ID常量</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ID_EX_UNKNOW = <span class="hljs-number">4</span>;</li><li>    </li><li>    <span class="hljs-comment">/**</span></li><li>     * 默认SFTP通信端口常量</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEF_SFTP_PORT = <span class="hljs-number">22</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 字节数组大小常量</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAX_BYTES_SIZE = <span class="hljs-number">204800</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * SFTP服务器根目录</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PWD_PATH = <span class="hljs-string">"/"</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 创建目录发生冲突时，线程睡眠时间</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> SLEEP_TIME = <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 远端SFTP服务器IP地址</li><li>     */</li><li>    <span class="hljs-keyword">private</span> String hostip;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 通信端口 默认22</li><li>     */</li><li>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 鉴权用户名称</li><li>     */</li><li>    <span class="hljs-keyword">private</span> String userName;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 鉴权用户密码</li><li>     */</li><li>    <span class="hljs-keyword">private</span> String passWord;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * Jsch对象</li><li>     */</li><li>    <span class="hljs-keyword">private</span> JSch jsch;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 会话</li><li>     */</li><li>    <span class="hljs-keyword">private</span> Session session;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 通道</li><li>     */</li><li>    <span class="hljs-keyword">private</span> Channel channel;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * Sftp服务应用通道</li><li>     */</li><li>    <span class="hljs-keyword">private</span> ChannelSftp sftpChannel;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * Sftp密钥路径</li><li>     */</li><li>    <span class="hljs-keyword">private</span> String keyPath;</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 构造函数&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> ip String 远端SFTP服务器IP地址</li><li>     * <span class="hljs-doctag">@param</span> port 通信端口</li><li>     * <span class="hljs-doctag">@param</span> user 鉴权用户名称</li><li>     * <span class="hljs-doctag">@param</span> password 鉴权用户密码</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SftpClientImpl</span><span class="hljs-params">(String ip, <span class="hljs-keyword">int</span> port, String user, String password)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">this</span>.hostip = ip;</li><li>        <span class="hljs-keyword">this</span>.port = port;</li><li>        <span class="hljs-keyword">this</span>.userName = user;</li><li>        <span class="hljs-comment">//TODO密码需要加密</span></li><li>        <span class="hljs-keyword">this</span>.passWord = password;</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 构造函数，使用默认端口&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> ip String 远端SFTP服务器IP地址</li><li>     * <span class="hljs-doctag">@param</span> user 鉴权用户名称</li><li>     * <span class="hljs-doctag">@param</span> password 鉴权用户密码</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SftpClientImpl</span><span class="hljs-params">(String ip, String user, String password)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">this</span>.hostip = ip;</li><li>        <span class="hljs-keyword">this</span>.port = DEF_SFTP_PORT;</li><li>        <span class="hljs-keyword">this</span>.userName = user;</li><li>        <span class="hljs-comment">//TODO SFTP密码加密</span></li><li>        <span class="hljs-keyword">this</span>.passWord = password;</li><li>        <span class="hljs-keyword">this</span>.keyPath = <span class="hljs-keyword">null</span>;</li><li>    }</li><li></li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setKeyPath</span><span class="hljs-params">(String path)</span></span></li><li>    {</li><li>        keyPath = path;</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 与远端SFTP服务器建立连接&lt;br&gt;</li><li>     * <span class="hljs-doctag">@throws</span> InvokeException 异常</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            jsch = <span class="hljs-keyword">new</span> JSch();</li><li>            <span class="hljs-comment">// 如果存在密钥，则使用密钥认证</span></li><li>            <span class="hljs-comment">// if(null != keyPath &amp;&amp;(new File(keyPath).exists()))</span></li><li>            <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">null</span> != keyPath) &amp;&amp; (!<span class="hljs-string">""</span>.equals(keyPath)))</li><li>            {</li><li>                File tmpKeyFile = <span class="hljs-keyword">new</span> File(keyPath);</li><li>                <span class="hljs-keyword">if</span> (tmpKeyFile.exists())</li><li>                {</li><li>                    <span class="hljs-comment">// 设置认证文件路径</span></li><li>                    jsch.addIdentity(keyPath);</li><li>                }</li><li>                <span class="hljs-keyword">else</span></li><li>                {</li><li>                    <span class="hljs-comment">// 认证文件不存在，则使用密码</span></li><li>                    logger.error(<span class="hljs-string">"The key path file of authorization does not exist. Finish establish connection ..."</span>);</li><li>                    logger.error(<span class="hljs-string">"Input key file is: ["</span> + keyPath + <span class="hljs-string">"]"</span>);</li><li>                }</li><li>            }</li><li></li><li>            session = jsch.getSession(userName, hostip, port);</li><li>            logger.info(<span class="hljs-string">"FTP connect: connect():\nUser name:["</span> + userName + <span class="hljs-string">"], IP:["</span> + hostip + <span class="hljs-string">"], Port:["</span> + port</li><li>                    + <span class="hljs-string">"], sftp key path:["</span> + keyPath + <span class="hljs-string">"]"</span>);</li><li>            session.setPassword(passWord);</li><li>            java.util.Properties config = <span class="hljs-keyword">new</span> java.util.Properties();</li><li>            session.setConfig(<span class="hljs-string">"userauth.gssapi-with-mic"</span>, <span class="hljs-string">"no"</span>);</li><li>            config.put(<span class="hljs-string">"StrictHostKeyChecking"</span>, <span class="hljs-string">"no"</span>); <span class="hljs-comment">// 不验证HostKey</span></li><li>            session.setConfig(config);</li><li>            session.connect();</li><li>            channel = session.openChannel(<span class="hljs-string">"sftp"</span>);</li><li>            channel.connect();</li><li>            sftpChannel = (ChannelSftp) channel;</li><li>            logger.info(<span class="hljs-string">"Connect to sftp server succeed!"</span>);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to connect,Exception: "</span>, e);          </li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 断开与远端SFTP服务器连接&lt;br&gt;</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span></span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            <span class="hljs-comment">// 结束会话</span></li><li>            sftpChannel.quit();</li><li>            sftpChannel.exit();</li><li>            session.disconnect();</li><li>            logger.info(<span class="hljs-string">"Disconnect from sftp server succeed!"</span>);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to disconnect,Exception: "</span> + e.toString());</li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 上载文件&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcPath 文件的本地目录路径须以"/"结束</li><li>     * <span class="hljs-doctag">@param</span> destPath 存放文件的服务器目录路径,路径须以"/"结束</li><li>     * <span class="hljs-doctag">@throws</span> InvokeException 异常</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">upload</span><span class="hljs-params">(String srcPath, String destPath)</span></span></li><li>    {</li><li>    	logger.debug(<span class="hljs-string">"upload()---start."</span>);</li><li>        <span class="hljs-comment">// 屏蔽单个文件上载和文件目录下多个文件上载实现上的差异，增加判断处理</span></li><li>        <span class="hljs-keyword">if</span> ((srcPath.endsWith(<span class="hljs-string">"/"</span>)) &amp;&amp; (destPath.endsWith(<span class="hljs-string">"/"</span>)))</li><li>        {</li><li>            <span class="hljs-comment">// 远端服务器存放文件路径是否存在，不存在创建之</span></li><li>            checkDirExist(destPath);</li><li>            List&lt;String&gt; filesList = FileUtil.getFileLists(srcPath);</li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; filesList.size(); i++)</li><li>            {</li><li>                String temp = filesList.get(i);</li><li>                <span class="hljs-keyword">if</span> (temp.endsWith(<span class="hljs-string">"txt"</span>))</li><li>                {</li><li>                    <span class="hljs-keyword">try</span></li><li>                    {</li><li>                        upFile(srcPath + filesList.get(i), destPath + filesList.get(i));</li><li>                        logger.info(<span class="hljs-string">"Upload files to "</span> + destPath + <span class="hljs-string">" succeed!"</span>);</li><li>                    }</li><li>                    <span class="hljs-keyword">catch</span> (Exception e)</li><li>                    {</li><li>                        logger.error(<span class="hljs-string">"Failed to upload files to "</span> + destPath, e);</li><li>                    }</li><li>                }</li><li>            }</li><li></li><li>        }</li><li>        <span class="hljs-keyword">else</span></li><li>        {</li><li>            String realPath = destPath.substring(<span class="hljs-number">0</span>, destPath.lastIndexOf(<span class="hljs-string">'/'</span>) + <span class="hljs-number">1</span>);</li><li>            <span class="hljs-comment">// 远端服务器存放文件路径是否存在，不存在创建之</span></li><li>            checkDirExist(realPath);</li><li>            <span class="hljs-keyword">try</span></li><li>            {</li><li>                upFile(srcPath, destPath);</li><li>                logger.info(<span class="hljs-string">"Upload files to "</span> + destPath + <span class="hljs-string">" succeed!"</span>);</li><li>            }</li><li>            <span class="hljs-keyword">catch</span> (Exception e)</li><li>            {</li><li>                logger.error(<span class="hljs-string">"Failed to upload files to "</span> + destPath, e);</li><li>            }</li><li></li><li>        }</li><li>        <span class="hljs-comment">// 性能文件上传从根目录</span></li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            sftpChannel.cd(PWD_PATH);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Return to home path failed,caused by "</span>, e);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)<span class="hljs-comment">// 捕捉其它异常</span></li><li>        {</li><li>            logger.error(<span class="hljs-string">"Return to home path failed,caused by "</span>, e);</li><li>        }</li><li>        logger.debug(<span class="hljs-string">"upload()---end."</span>);</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 上载到服务器 目录是否存在，如果不存在，则创建&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> path 服务器文本存放路径</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkDirExist</span><span class="hljs-params">(String path)</span></span></li><li>    {</li><li>        <span class="hljs-comment">// 上载到服务器 目录是否存在，如果不存在，则创建</span></li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>        	sftpChannel.cd(PWD_PATH);</li><li>            logger.info(<span class="hljs-string">"path = "</span> + path);</li><li>            sftpChannel.cd(path);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            <span class="hljs-keyword">if</span> (e.id == ID_EX_DIRNOTEXIST)</li><li>            {</li><li>                checkInnerDirExist(path);</li><li>            }</li><li>            <span class="hljs-keyword">else</span></li><li>            {</li><li>                logger.error(<span class="hljs-string">"Failed to other reason outside,caused by "</span>, e);</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e5)<span class="hljs-comment">// 捕捉其它异常</span></li><li>        {</li><li>            logger.error(<span class="hljs-string">"checkDirExist Failed for other reason, Exception:"</span>, e5);</li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 检查内部的路径是否存在 &lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> path 上载到服务器 目录</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkInnerDirExist</span><span class="hljs-params">(String path)</span></span></li><li>    {</li><li>        String[] section = path.split(<span class="hljs-string">"/"</span>);</li><li>        String absolutePath = <span class="hljs-string">"/"</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; section.length; i++)</li><li>        {</li><li>            <span class="hljs-keyword">try</span></li><li>            {</li><li>                <span class="hljs-comment">// l00122960 1108解决PMD问题修改下列代码，字符串比较，常量应该放置在左侧</span></li><li>                <span class="hljs-keyword">if</span> (!(<span class="hljs-string">"/"</span>.equals(absolutePath)) &amp;&amp; !((sftpChannel.pwd() + <span class="hljs-string">"/"</span>).equals(absolutePath)))</li><li>                {</li><li>                    logger.error(<span class="hljs-string">"the current Dir has been changed abnormally,the absolutePath is "</span> + absolutePath</li><li>                            + <span class="hljs-string">"but the current path is "</span> + sftpChannel.pwd());</li><li>                }</li><li>                logger.info(<span class="hljs-string">"section["</span> + i + <span class="hljs-string">"] = "</span> + section[i]);</li><li>                absolutePath += section[i] + <span class="hljs-string">"/"</span>;</li><li>                sftpChannel.cd(absolutePath);</li><li>            }</li><li>            <span class="hljs-keyword">catch</span> (SftpException e1)</li><li>            {</li><li>                <span class="hljs-comment">// 循环下级目录是否存在，不存在继续创建</span></li><li>                <span class="hljs-keyword">if</span> (e1.id == ID_EX_DIRNOTEXIST)</li><li>                {</li><li>                    <span class="hljs-keyword">try</span></li><li>                    {</li><li>                        logger.info(<span class="hljs-string">"absolutePath : "</span> + absolutePath);</li><li>                        sftpChannel.mkdir(absolutePath);</li><li>                        logger.info(<span class="hljs-string">"absolutePath after mkdir : "</span> + absolutePath);</li><li>                        sftpChannel.cd(absolutePath);</li><li>                    }</li><li>                    <span class="hljs-keyword">catch</span> (SftpException e2)</li><li>                    {</li><li>                        <span class="hljs-comment">// 创建目录因为多线程冲突或（三方件抛出的）未知异常导致失败</span></li><li>                        <span class="hljs-keyword">if</span> (e2.id == ID_EX_MKDIRFAILD || e2.id == ID_EX_UNKNOW)</li><li>                        {</li><li>                            logger.error(<span class="hljs-string">"Conflicts happened when created Dir "</span> + section[i]</li><li>                                    + <span class="hljs-string">", begin to sleep current thread "</span> + SLEEP_TIME + <span class="hljs-string">" ms!"</span>);</li><li>                            <span class="hljs-keyword">try</span></li><li>                            {</li><li>                                Thread.sleep(SLEEP_TIME);</li><li>                            }</li><li>                            <span class="hljs-keyword">catch</span> (InterruptedException e4)</li><li>                            {</li><li>                                <span class="hljs-comment">// l00122960 1108 解决PMD问题修改下行代码</span></li><li>                                logger.error(<span class="hljs-string">"Failed to sleep the exception: "</span> + Thread.currentThread().getName(), e4);</li><li>                            }</li><li>                            logger.error(<span class="hljs-string">"End to sleep current thread !"</span>);</li><li></li><li>                            <span class="hljs-keyword">try</span></li><li>                            {</li><li>                                sftpChannel.cd(absolutePath);</li><li>                            }</li><li>                            <span class="hljs-keyword">catch</span> (SftpException e3)</li><li>                            {</li><li>                                <span class="hljs-comment">// 进入下一层目录失败，返回失败</span></li><li>                                <span class="hljs-keyword">if</span> (e3.id == ID_EX_DIRNOTEXIST)</li><li>                                {</li><li>                                    logger.error(<span class="hljs-string">"Failed to no Dir exist,caused by "</span>, e3);</li><li>                                    <span class="hljs-keyword">break</span>;</li><li>                                }</li><li>                                <span class="hljs-keyword">else</span></li><li>                                {</li><li>                                    logger.error(<span class="hljs-string">"Failed to cd Dir,caused by "</span>, e3);</li><li>                                    <span class="hljs-keyword">break</span>;</li><li>                                }</li><li>                            }</li><li>                        }</li><li>                        <span class="hljs-keyword">else</span></li><li>                        {</li><li>                            logger.error(<span class="hljs-string">"Failed to check and create Dir,caused by "</span>, e2);</li><li>                            <span class="hljs-keyword">break</span>;</li><li>                        }</li><li>                    }</li><li>                }</li><li>                <span class="hljs-keyword">else</span></li><li>                {</li><li>                    logger.error(<span class="hljs-string">"Failed to other reason,caused by "</span>, e1);</li><li>                    <span class="hljs-keyword">break</span>;</li><li>                }</li><li>            }</li><li>        }</li><li></li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 上传单个文件到FTP服务destFile路径以FTP服务器的"/"</li><li>     * <span class="hljs-doctag">@param</span> srcFile 源文件名</li><li>     * <span class="hljs-doctag">@param</span> destFile 目的文件</li><li>     * <span class="hljs-doctag">@throws</span> SftpException sftp异常</li><li>     * <span class="hljs-doctag">@throws</span> IOException IO异常</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">upFile</span><span class="hljs-params">(String srcFile, String destFile)</span> <span class="hljs-keyword">throws</span> SftpException, IOException</span></li><li>    {</li><li>    	logger.debug(<span class="hljs-string">"upFile()----start.srcFile: "</span> + srcFile +<span class="hljs-string">"; destFile: "</span> + destFile);</li><li>        OutputStream out = <span class="hljs-keyword">null</span>;</li><li>        FileInputStream in = <span class="hljs-keyword">null</span>;</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            File file = <span class="hljs-keyword">new</span> File(srcFile);</li><li></li><li>            <span class="hljs-comment">// 只有需要上传的文件存在，并且是文件而不是目录才上传</span></li><li>            <span class="hljs-keyword">if</span> (file.exists() &amp;&amp; file.isFile())</li><li>            {</li><li>                out = sftpChannel.put(destFile);</li><li>                in = <span class="hljs-keyword">new</span> FileInputStream(srcFile);</li><li>                <span class="hljs-keyword">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[MAX_BYTES_SIZE];</li><li>                <span class="hljs-keyword">int</span> bufsize = in.read(data, <span class="hljs-number">0</span>, data.length);</li><li>                <span class="hljs-keyword">while</span> (bufsize != -<span class="hljs-number">1</span>)</li><li>                {</li><li>                    out.write(data, <span class="hljs-number">0</span>, bufsize);</li><li>                    bufsize = in.read(data, <span class="hljs-number">0</span>, data.length);</li><li>                }</li><li>                out.flush();</li><li>                out.close();</li><li>                in.close();</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            String exceptionInfo = <span class="hljs-string">"sftpException"</span>;</li><li>            StackTraceElement exceptionObj = <span class="hljs-keyword">new</span> StackTraceElement(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, exceptionInfo, <span class="hljs-number">0</span>);</li><li>            StackTraceElement[] exceptionObjs = { exceptionObj };</li><li>            e.setStackTrace(exceptionObjs);</li><li>            logger.error(<span class="hljs-string">"Failed to upload file,caused by "</span> + e.toString());</li><li>            <span class="hljs-keyword">throw</span> e;</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (FileNotFoundException e)</li><li>        {</li><li>            String exceptionInfo = <span class="hljs-string">"fileNotFoundException"</span>;</li><li>            StackTraceElement exceptionObj = <span class="hljs-keyword">new</span> StackTraceElement(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, exceptionInfo, <span class="hljs-number">0</span>);</li><li>            StackTraceElement[] exceptionObjs = { exceptionObj };</li><li>            e.setStackTrace(exceptionObjs);</li><li>            logger.error(<span class="hljs-string">"Failed to upload file,caused by "</span> + e.toString());</li><li>            <span class="hljs-keyword">throw</span> e;</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (IOException e)</li><li>        {</li><li>            String exceptionInfo = <span class="hljs-string">"ioException"</span>;</li><li>            StackTraceElement exceptionObj = <span class="hljs-keyword">new</span> StackTraceElement(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, exceptionInfo, <span class="hljs-number">0</span>);</li><li>            StackTraceElement[] exceptionObjs = { exceptionObj };</li><li>            e.setStackTrace(exceptionObjs);</li><li>            logger.error(<span class="hljs-string">"Failed to upload file,caused by "</span> + e.toString());</li><li>            <span class="hljs-keyword">throw</span> e;</li><li>        }</li><li>        <span class="hljs-keyword">finally</span></li><li>        {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != in)</li><li>            {</li><li>                <span class="hljs-keyword">try</span></li><li>                {</li><li>                    in.close();</li><li>                }</li><li>                <span class="hljs-keyword">catch</span> (IOException e)</li><li>                {</li><li>                    logger.error(<span class="hljs-string">"Failed to close the TelnetInputStream."</span>, e);</li><li>                }</li><li>            }</li><li></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != out)</li><li>            {</li><li>                <span class="hljs-keyword">try</span></li><li>                {</li><li>                    out.close();</li><li>                }</li><li>                <span class="hljs-keyword">catch</span> (IOException e)</li><li>                {</li><li>                    logger.error(<span class="hljs-string">"Failed to close the OutputStream."</span>, e);</li><li>                }</li><li>            }</li><li>        }</li><li>        logger.debug(<span class="hljs-string">"upFile()----end."</span>);</li><li></li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 下载文件&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcPath 文件的服务器目录路径,路径须以"/"结束</li><li>     * <span class="hljs-doctag">@param</span> destPath 用于存放文件的本地目录路径须以"/"结束</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">download</span><span class="hljs-params">(String srcPath, String destPath)</span></span></li><li>    {</li><li>        <span class="hljs-comment">// 屏蔽单个文件下载和文件目录下多个文件下载实现上的差异，增加判断处理</span></li><li>        <span class="hljs-keyword">if</span> ((srcPath.endsWith(<span class="hljs-string">"/"</span>)) &amp;&amp; (destPath.endsWith(<span class="hljs-string">"/"</span>)))</li><li>        {</li><li>            downFiles(srcPath, destPath);</li><li>            logger.info(<span class="hljs-string">"Download files to "</span> + destPath + <span class="hljs-string">" succeed!"</span>);</li><li>        }</li><li>        <span class="hljs-keyword">else</span></li><li>        {</li><li>            downFile(srcPath, destPath);</li><li>            logger.info(<span class="hljs-string">"Download files to "</span> + destPath + <span class="hljs-string">" succeed!"</span>);</li><li>        }</li><li></li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 下载文件（指定目录下的所有文件）&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcPath 文件的服务器目录路径,路径须以"/"结束</li><li>     * <span class="hljs-doctag">@param</span> destPath 用于存放文件的本地目录路径须以"/"结束</li><li>     */</li><li>    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">downFiles</span><span class="hljs-params">(String srcPath, String destPath)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            <span class="hljs-comment">// 读取文件目录下的文件列表</span></li><li>            sftpChannel.cd(srcPath);</li><li>            Vector&lt;Object&gt; vector = sftpChannel.ls(srcPath);</li><li>            <span class="hljs-keyword">if</span> (vector != <span class="hljs-keyword">null</span>)</li><li>            {</li><li>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++)</li><li>                {</li><li>                    Object obj = vector.elementAt(i);</li><li>                    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> com.jcraft.jsch.ChannelSftp.LsEntry)</li><li>                    {</li><li>                        SftpATTRS atrr = ((com.jcraft.jsch.ChannelSftp.LsEntry) obj).getAttrs();</li><li>                        String fileName = ((com.jcraft.jsch.ChannelSftp.LsEntry) obj).getFilename();</li><li>                        <span class="hljs-comment">// l00122960 1108 解决PMD问题修改下列代码 字符串比较，常量放置在左侧，合并if条件</span></li><li>                        <span class="hljs-keyword">if</span> (!(<span class="hljs-string">".."</span>.equals(fileName)) &amp;&amp; !(<span class="hljs-string">"."</span>.equals(fileName)) &amp;&amp; !atrr.isDir())</li><li>                        {</li><li>                            downFile(srcPath + fileName, destPath + fileName);</li><li>                        }</li><li>                        atrr = <span class="hljs-keyword">null</span>;</li><li>                    }</li><li>                    obj = <span class="hljs-keyword">null</span>;</li><li>                }</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to download files,caused by "</span> + e.toString());</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to download files,caused by "</span> + e.toString());</li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * 从SFTP文件服务器上下载文件名中都要求包括完整的路径名在内&lt;br&gt;</li><li>     * <span class="hljs-doctag">@param</span> srcFile 源文件名</li><li>     * <span class="hljs-doctag">@param</span> destFile 目的文件</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">downFile</span><span class="hljs-params">(String srcFile, String destFile)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            sftpChannel.get(srcFile, destFile);</li><li>            logger.info(<span class="hljs-string">"Download the single file succeed!"</span>);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to download the single file,caused by "</span> + e.toString());</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Failed to download the single file,caused by "</span> + e.toString());</li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * SFTP远程对现有的文件重命</li><li>     * <span class="hljs-doctag">@param</span> oldname 旧名称</li><li>     * <span class="hljs-doctag">@param</span> newname 新名称</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeName</span><span class="hljs-params">(String oldname, String newname)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            sftpChannel.rename(oldname, newname);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"rename file failed!  "</span> + e.toString() + <span class="hljs-string">"  "</span> + e);</li><li>            <span class="hljs-keyword">try</span></li><li>            {</li><li>                sftpChannel.rm(oldname);</li><li>            }</li><li>            <span class="hljs-keyword">catch</span> (SftpException e1)</li><li>            {</li><li>                logger.error(<span class="hljs-string">"delete file failed!  "</span> + e1.toString() + <span class="hljs-string">"  "</span> + e1);</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"rename file failed!caused by "</span> + e.toString());</li><li>        }</li><li>    }</li><li></li><li>    <span class="hljs-comment">/**</span></li><li>     * SFTP远程修改上传文件的权限</li><li>     * <span class="hljs-doctag">@param</span> oldname 旧名称</li><li>     * <span class="hljs-doctag">@param</span> newname 新名称</li><li>     */</li><li>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changePermissions</span><span class="hljs-params">(<span class="hljs-keyword">int</span> perssions, String filename)</span></span></li><li>    {</li><li>        <span class="hljs-keyword">try</span></li><li>        {</li><li>            sftpChannel.chmod(perssions, filename);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (SftpException e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"SFTPException occurred when change the permissions for remote file of ["</span> + filename</li><li>                    + <span class="hljs-string">"]! Caused by:"</span>);</li><li>            logger.error(e.toString() + <span class="hljs-string">"  "</span> + e);</li><li>        }</li><li>        <span class="hljs-keyword">catch</span> (Exception e)</li><li>        {</li><li>            logger.error(<span class="hljs-string">"Other exception occurred when change the permissions for remote file of ["</span> + filename</li><li>                    + <span class="hljs-string">"]! Caused by:"</span>);</li><li>            logger.error(e.toString() + <span class="hljs-string">"  "</span> + e);</li><li>        }</li><li>    }</li><li>}</li></ol></code></pre>
			<div><br />
			</div>
		</div>
	</body>
</html>
